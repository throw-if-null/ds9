{
  "name": "Foreman",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "run-foreman",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [3632, 864],
      "id": "54d064be-b699-419a-abdf-73ebc1376803",
      "name": "Start",
      "webhookId": "25673ee8-bf54-43e5-9912-6ae2db478f78"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "retry_count",
              "value": "0"
            },
            {
              "name": "max_retries",
              "value": "3"
            },
            {
              "name": "task_id",
              "value": "={{ $json.body.task_id }}"
            },
            {
              "name": "prompt",
              "value": "={{ $json.body.prompt }}"
            },
            {
              "name": "worktree_path",
              "value": "=.oc_worktrees/{{ $json.body.task_id }}"
            },
            {
              "name": "timeStamp",
              "value": "={{(()=>{\n  return DateTime.now().toFormat('yyyyLLdd.HHmm');\n})()}}"
            },
            {
              "name": "mode",
              "value": "={{ (() => {\n  const url = $json.webhookUrl || '';\n  if (url.endsWith('run-foreman')) return 'full';\n  if (url.endsWith('run-inspector')) return 'review';\n  return 'unknown';\n})() }}"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [3920, 992],
      "id": "032eb0aa-204d-4916-acba-d6425264fcfe",
      "name": "Initialize Variables"
    },
    {
      "parameters": {
        "command": "=REPO=\"/home/backsippan/gh/etc/ds9\"\n\ngit -C \"$REPO\" worktree add -b feature/{{ $json.task_id }} {{ $json.worktree_path }} main"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [4336, 864],
      "id": "34966bac-8383-4631-832a-c416af0c5009",
      "name": "Setup Git Worktree"
    },
    {
      "parameters": {
        "command": "=# 1. Define paths\nREPO=\"/home/backsippan/gh/etc/ds9\"\nRUNNER_SCRIPT=\"$REPO/.foreman/tools/agent_runner.py\"\nWORKTREE=\"{{ $('Initialize Variables').item.json.worktree_path }}\"\nRESUME_URL=\"{{ $execution.resumeUrl }}\"\n\n# 2. Build a prompt file safely (no command substitution)\nPROMPT_FILE=\"$REPO/.foreman/.tmp/builder_{{ $('Initialize Variables').item.json.body.task_id }}.prompt.md\"\nmkdir -p \"$(dirname \"$PROMPT_FILE\")\n\ncat \"$REPO/.foreman/builder/templates/builder_base_prompt.md\" > \"$PROMPT_FILE\"\ncat <<'EOF' >> \"$PROMPT_FILE\"\n\nThe user task is:\n{{ $('Initialize Variables').item.json.body.prompt }}\nEOF\n\n# 3. Execution: run Builder via agent_runner.py using base64 prompt\nnohup python3 \"$RUNNER_SCRIPT\" \\\n  --webhook \"$RESUME_URL\" \\\n  --cwd \"$WORKTREE\" \\\n  --base64 \\\n  --cmd \"$(base64 -w0 < \"$PROMPT_FILE\")\" \\\n  --title \"BUILDER {{ $('Initialize Variables').item.json.body.task_id }} {{ $('Initialize Variables').item.json.timeStamp }}\" \\\n  --agent builder \\\n  > /dev/null 2>&1 &"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [4832, 864],
      "id": "09957eb7-4bef-4413-a173-92899588121e",
      "name": "Run Builder Agent",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "resume": "webhook",
        "httpMethod": "POST",
        "options": {}
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [5024, 864],
      "id": "f963019d-5a3c-466a-9793-16e7a36632ae",
      "name": "Wait for Builder",
      "webhookId": "7fae1480-f059-48d9-9a0d-864c586b17a0"
    },
    {
      "parameters": {
        "command": "=REPO=\"/home/backsippan/gh/etc/ds9\"\nWORKTREE=\"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\"\n\ncd \"$WORKTREE\" && \\\ngit diff main...HEAD > inspector_diff.patch"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [4992, 1088],
      "id": "b90d808d-de00-4f86-b00c-c646b5ed2d87",
      "name": "Create the DIFF"
    },
    {
      "parameters": {
        "command": "=# 1. Define paths\nREPO=\"/home/backsippan/gh/etc/ds9\"\nRUNNER_SCRIPT=\"$REPO/.foreman/tools/agent_runner.py\"\nWORKTREE=\"{{ $('Initialize Variables').item.json.worktree_path }}\"\nRESUME_URL=\"{{ $execution.resumeUrl }}\"\n\n# 2. Build a prompt file safely (no command substitution)\nPROMPT_FILE=\"$REPO/.foreman/.tmp/inspector_{{ $('Initialize Variables').item.json.body.task_id }}.prompt.md\"\nmkdir -p \"$(dirname \"$PROMPT_FILE\")\n\ncat \"$REPO/.foreman/inspector/templates/inspector_base_prompt.md\" > \"$PROMPT_FILE\"\ncat <<'EOF' >> \"$PROMPT_FILE\"\n\nThe task being reviewed is:\n{{ $('Initialize Variables').item.json.body.prompt }}\nEOF\n\n# 3. Execution: run Inspector via agent_runner.py using base64 prompt\nnohup python3 \"$RUNNER_SCRIPT\" \\\n  --webhook \"$RESUME_URL\" \\\n  --cwd \"$WORKTREE\" \\\n  --base64 \\\n  --cmd \"$(base64 -w0 < \"$PROMPT_FILE\")\" \\\n  --title \"INSPECTOR {{ $('Initialize Variables').item.json.body.task_id }} {{ $('Initialize Variables').item.json.timeStamp }}\" \\\n  --agent inspector \\\n  > /dev/null 2>&1 &"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [5152, 1088],
      "id": "65c3372d-b946-4493-9243-b5c18ab519e8",
      "name": "Run Inspector Agent",
      "notesInFlow": false,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "resume": "webhook",
        "httpMethod": "POST",
        "options": {}
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [4352, 1360],
      "id": "f61c0b44-900f-47dc-9ef7-f6e5cd178386",
      "name": "Wait fo Inspector",
      "webhookId": "19eb0f2f-c982-4e12-92f6-be4cdcb74ee9",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "command": "=REPO=\"/home/backsippan/gh/etc/ds9\"\n\npython \"$REPO/.foreman/tools/create_pr.py\" \\\n  --task-id \"{{ $('Initialize Variables').first().json.task_id }}\" \\\n  --title \"feat: {{ $('Initialize Variables').first().json.task_id }} implementation\" \\\n  --body \"{{ $('Initialize Variables').first().json.body.prompt }}\" \\\n  --worktree \"$REPO/{{ $('Initialize Variables').first().json.worktree_path }}\" \\\n  --branch \"feature/{{ $('Initialize Variables').first().json.task_id }}\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [5200, 1440],
      "id": "4f199f0c-b522-4da4-b5a4-833973f7e479",
      "name": "Create the PR"
    },
    {
      "parameters": {
        "command": "=TASK_ID=\"{{ $('Initialize Variables').first().json.task_id }}\"\n\nWHO=\"builder\"\nif [ \"{{ $json.data.work.status || '' }}\" != \"\" ]; then\n  WHO=\"inspector\"\nfi\n\nREPORT_DIR=\".foreman/failures/$WHO\"\nREPORT_FILE=\"$REPORT_DIR/${TASK_ID}_report.json\"\nmkdir -p \"$REPORT_DIR\"\n\nREASON=\"unknown\"\nif [ \"{{ $json.status }}\" != \"valid\" ]; then\n  REASON=\"result_invalid\"\nelif [ \"{{ $json.data.run.status }}\" != \"ok\" ]; then\n  REASON=\"run_failed\"\nelif [ \"{{ $json.data.work.status || '' }}\" != \"approved\" ]; then\n  REASON=\"changes_requested\"\nelse\n  REASON=\"unexpected\"\nfi\n\nFOREMAN_STATUS=\"{{ $json.status }}\" \\\nFOREMAN_REASON=\"$REASON\" \\\nFOREMAN_RAW_JSON='{{ JSON.stringify($json) }}' \\\npython3 - <<'PY' > \"$REPORT_FILE\"\nimport json\nimport os\n\nstatus = os.environ.get('FOREMAN_STATUS')\nreason = os.environ.get('FOREMAN_REASON')\nraw = os.environ.get('FOREMAN_RAW_JSON')\n\ntry:\n    payload = json.loads(raw)\nexcept Exception:\n    payload = None\n\ndata = (payload.get('data') if isinstance(payload, dict) else None) or {}\n\nout = {\n    'status': status,\n    'reason': reason,\n    'errors': (payload.get('errors') if isinstance(payload, dict) else None),\n    'data': {\n        'run': data.get('run'),\n        'work': data.get('work'),\n    },\n}\nprint(json.dumps(out, ensure_ascii=False))\nPY"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [5200, 1296],
      "id": "1b7ecb71-1ade-48f7-bb68-198575be4945",
      "name": "Log Rejection"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "90ec06b4-7f79-490b-8459-b93dddfcad09",
              "leftValue": "={{ $json.status }}",
              "rightValue": "valid",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "2e9ba515-993c-4378-a68f-b6ff997fa2cc",
              "leftValue": "={{ $json.data.run.status }}",
              "rightValue": "ok",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [4752, 1088],
      "id": "b2fb4d14-6183-4592-8556-db7e171781c2",
      "name": "Is Builder OK"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "e4238de8-6dfb-4cf6-b62b-1b4df22407eb",
              "leftValue": "={{ $json.status }}",
              "rightValue": "valid",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "0a71aede-43b0-4f73-9570-798181800b51",
              "leftValue": "={{ $json.data.run.status }}",
              "rightValue": "ok",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "ebce3b67-55cd-4285-a8a6-6c6c5758a8f0",
              "leftValue": "={{ $json.data.work.status }}",
              "rightValue": "approved",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [4976, 1360],
      "id": "e8848f2f-3247-473e-a6bb-83eb437fa5be",
      "name": "Is Inspector OK"
    },
    {
      "parameters": {
        "command": "=REPO=\"/home/backsippan/gh/etc/ds9\"\n\ncd \"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\" && \\\n  python \"$REPO/.foreman/tools/check_builder_handoff.py\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [4352, 1088],
      "id": "f7fba4cc-4ad7-4e31-a60a-3e4a5ec3142e",
      "name": "Check Builder Handoff"
    },
    {
      "parameters": {
        "jsCode": "const text = $json.stdout || '';\n\nlet result;\ntry {\n  result = JSON.parse(text);\n} catch (e) {\n  throw new Error('Failed to parse handoff JSON: ' + e.message);\n}\n  // n8n expects an array of items\nreturn [result];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4544, 1088],
      "id": "ef394d40-38b3-4f4d-89b7-b89c3ec2be42",
      "name": "Process the response"
    },
    {
      "parameters": {
        "command": "=REPO=\"/home/backsippan/gh/etc/ds9\"\n\ncd \"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\" && \\\n  python \"$REPO/.foreman/tools/check_inspector_handoff.py\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [4560, 1360],
      "id": "acbb6650-8826-4788-9801-544690bdc09f",
      "name": "Check Inspector Handoff"
    },
    {
      "parameters": {
        "jsCode": "const text = $json.stdout || '';\n\nlet result;\ntry {\n  result = JSON.parse(text);\n} catch (e) {\n  throw new Error('Failed to parse handoff JSON: ' + e.message);\n}\n  // n8n expects an array of items\nreturn [result];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4784, 1360],
      "id": "bd5db19b-9c43-49ad-a13c-ca906a671ba5",
      "name": "Process the response1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "run-inspector",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [3632, 1152],
      "id": "7d0d4bb4-878b-4bca-9237-1d3d5b19b0dc",
      "name": "Review",
      "webhookId": "0d33a427-d5ca-4d31-8dda-d8a963a9db4e"
    },
    {
      "parameters": {
        "command": "=REPO=\"/home/backsippan/gh/etc/ds9\"\n\ncd \"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}/components\" && \\\npnpm i"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [4512, 864],
      "id": "938ab0db-6c9e-4a7c-9557-92a7d60c7eea",
      "name": "Setup Repository"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.mode }}",
                    "rightValue": "full",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8ad8fcbe-21de-4473-bebb-ec4019dedcd4"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "275c73f6-2b12-46a9-849d-1ae68bd8f94a",
                    "leftValue": "={{ $json.mode }}",
                    "rightValue": "review",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [4112, 992],
      "id": "ceb666c6-808d-491a-8e87-751541108cf6",
      "name": "Switch"
    }
  ],
  "pinData": {},
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "Initialize Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initialize Variables": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Git Worktree": {
      "main": [
        [
          {
            "node": "Setup Repository",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Builder Agent": {
      "main": [
        [
          {
            "node": "Wait for Builder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Builder": {
      "main": [
        [
          {
            "node": "Check Builder Handoff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create the DIFF": {
      "main": [
        [
          {
            "node": "Run Inspector Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Inspector Agent": {
      "main": [
        [
          {
            "node": "Wait fo Inspector",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait fo Inspector",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait fo Inspector": {
      "main": [
        [
          {
            "node": "Check Inspector Handoff",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Inspector Handoff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Inspector OK": {
      "main": [
        [
          {
            "node": "Create the PR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Rejection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Builder OK": {
      "main": [
        [
          {
            "node": "Create the DIFF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Rejection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Builder Handoff": {
      "main": [
        [
          {
            "node": "Process the response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process the response": {
      "main": [
        [
          {
            "node": "Is Builder OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Inspector Handoff": {
      "main": [
        [
          {
            "node": "Process the response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process the response1": {
      "main": [
        [
          {
            "node": "Is Inspector OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Review": {
      "main": [
        [
          {
            "node": "Initialize Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Repository": {
      "main": [
        [
          {
            "node": "Run Builder Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Setup Git Worktree",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Builder Handoff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "timezone": "Europe/Stockholm",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "f7b22c7f-4bee-4f2c-9bb1-8223f209199a",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b11168fb8d2189bb65765ba38337a8f759c5093954de979172c9be19e0a9355a"
  },
  "id": "dPFeMtNgFfJcco6V",
  "tags": []
}
